<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³–å°¿ç—…ç²¾æº–æ±ºç­–ç³»çµ± - è¡›ç¦éƒ¨ä»‹æ¥ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0061f2; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; margin: 0; padding: 20px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .header { border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; color: var(--primary); }
        #loading { text-align: center; padding: 50px; font-size: 1.2em; color: #666; }
        #error-msg { color: var(--danger); display: none; padding: 20px; border: 1px solid var(--danger); border-radius: 8px; }
        .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        .big-val { font-size: 3rem; font-weight: bold; text-align: center; margin: 10px 0; }
        .suggest-box { padding: 15px; border-radius: 8px; background: #f1f5f9; border-left: 5px solid #cbd5e1; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading">ğŸ“¡ æ­£åœ¨å¾è¡›ç¦éƒ¨ä¼ºæœå™¨åŒæ­¥ç—…æ‚£è³‡æ–™...</div>
    <div id="error-msg"></div>

    <div id="content" style="display:none;">
        <div class="card">
            <h2 class="header">ğŸ¥ ç³–å°¿ç—…ç²¾æº–æ±ºç­–æ”¯æ´ç³»çµ± (CDSS)</h2>
            <p id="p-info" style="font-weight: 500;"></p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>æœ€æ–°ç³–åŒ–è¡€è‰²ç´  (HbA1c)</h3>
                <div id="curr-a1c" class="big-val">--%</div>
                <div id="status-tag" style="text-align:center; font-weight:bold;"></div>
                <hr>
                <h4>ğŸ’¡ è‡¨åºŠå»ºè­°</h4>
                <div id="suggestion" class="suggest-box">åˆ†æä¸­...</div>
            </div>

            <div class="card">
                <h3>HbA1c æ­·å²è¶¨å‹¢åœ–</h3>
                <canvas id="a1cChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    FHIR.oauth2.ready()
        .then(client => {
            console.log("FHIR Client Ready", client);
            
            // åŒæ™‚æŠ“å–ç—…æ‚£è³‡æ–™èˆ‡ HbA1c æª¢é©—å€¼
            // æœå°‹ä»£ç¢¼åŒ…å« 10230-1 (å¸¸ç”¨) èˆ‡ 4548-4 (åœ‹éš›æ¨™æº–)
            const query = new URLSearchParams();
            query.set("patient", client.patient.id);
            query.set("code", "10230-1,4548-4");
            query.set("_sort", "-date");

            return Promise.all([
                client.patient.read(),
                client.request(`Observation?${query.toString()}`)
            ]);
        })
        .then(([patient, a1cBundle]) => {
            document.getElementById("loading").style.display = "none";
            document.getElementById("content").style.display = "block";

            // 1. é¡¯ç¤ºç—…æ‚£åŸºæœ¬è³‡è¨Š
            const name = patient.name ? patient.name[0].text : "éš±åç—…æ‚£";
            const gender = patient.gender === 'male' ? 'ç”·' : 'å¥³';
            document.getElementById("p-info").innerText = `ğŸ‘¤ ç—…æ‚£ï¼š${name} | æ€§åˆ¥ï¼š${gender} | åºè™Ÿï¼š${patient.id}`;

            // 2. è™•ç† HbA1c æ•¸æ“š
            let a1cDates = [];
            let a1cValues = [];
            
            if (a1cBundle.entry && a1cBundle.entry.length > 0) {
                // è½‰ç‚ºæ—¥æœŸæ’åº
                const entries = [...a1cBundle.entry].reverse();
                entries.forEach(e => {
                    const val = e.resource.valueQuantity ? e.resource.valueQuantity.value : null;
                    const date = e.resource.effectiveDateTime ? new Date(e.resource.effectiveDateTime).toLocaleDateString() : 'æœªçŸ¥æ—¥æœŸ';
                    if (val) {
                        a1cDates.push(date);
                        a1cValues.push(val);
                    }
                });
            }

            const latestA1c = a1cValues.length > 0 ? a1cValues[a1cValues.length - 1] : null;

            // 3. æ¸²æŸ“æ•¸æ“šèˆ‡å»ºè­°
            if (latestA1c) {
                const displayDiv = document.getElementById("curr-a1c");
                const suggestDiv = document.getElementById("suggestion");
                const statusTag = document.getElementById("status-tag");
                
                displayDiv.innerText = latestA1c + "%";
                
                if (latestA1c >= 7.0) {
                    displayDiv.style.color = "var(--danger)";
                    statusTag.innerText = "ğŸ”´ æ§åˆ¶ä¸ä½³";
                    statusTag.style.color = "var(--danger)";
                    suggestDiv.innerHTML = "<b>å»ºè­°æªæ–½ï¼š</b><br>1. è€ƒæ…®èµ·å§‹æˆ–åŠ å¼· Metformin æ²»ç™‚ã€‚<br>2. å®‰æ’ç‡Ÿé¤Šå¸«é€²è¡Œè¡›æ•™ã€‚<br>3. ä¸‰å€‹æœˆå¾Œè¿½è¹¤æª¢é©—ã€‚";
                } else {
                    displayDiv.style.color = "var(--success)";
                    statusTag.innerText = "ğŸŸ¢ æ§åˆ¶è‰¯å¥½";
                    statusTag.style.color = "var(--success)";
                    suggestDiv.innerHTML = "<b>ç¶­æŒç¾ç‹€ï¼š</b><br>1. æŒçºŒå‡è¡¡é£²é£Ÿèˆ‡é‹å‹•ã€‚<br>2. æŒ‰ç…§ç›®å‰é†«å›‘ç”¨è—¥ã€‚";
                }
            } else {
                document.getElementById("curr-a1c").innerText = "ç„¡è³‡æ–™";
                document.getElementById("suggestion").innerText = "ä¼ºæœå™¨ä¸­æŸ¥ç„¡æ­¤ç—…æ‚£çš„ HbA1c ç´€éŒ„ã€‚";
            }

            // 4. ç¹ªè£½åœ–è¡¨
            const ctx = document.getElementById('a1cChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: a1cDates,
                    datasets: [{
                        label: 'HbA1c (%)',
                        data: a1cValues,
                        borderColor: '#0061f2',
                        backgroundColor: 'rgba(0, 97, 242, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { min: 4, max: 12 } }
                }
            });
        })
        .catch(err => {
            console.error(err);
            document.getElementById("loading").style.display = "none";
            const errBox = document.getElementById("error-msg");
            errBox.style.display = "block";
            errBox.innerHTML = `<h3>âŒ ç³»çµ±é€£ç·šå¤±æ•—</h3><p>${err.message}</p><p>è«‹ç¢ºèªæ‚¨æ˜¯å¾ launch3.html å•Ÿå‹•ï¼Œä¸” Client ID å·²æ­£ç¢ºè¨­å®šã€‚</p>`;
        });
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³–å°¿ç—…ç²¾æº–æ±ºç­–ç³»çµ± V2 - SMART on FHIR</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0061f2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --tier1: #dcfce7; /* æ·ºç¶  - ç¬¬ä¸€ç·š */
            --tier2: #fef9c3; /* æ·ºé»ƒ - åŠ å¼· */
        }

        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; margin: 0; color: #1e293b; }
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        
        /* Header */
        header { background: #1e293b; color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
        
        .grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }

        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .card-title { font-weight: 700; color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; }
        .card-title::before { content: ""; width: 4px; height: 18px; background: var(--primary); margin-right: 10px; border-radius: 2px; }

        /* è—¥ç‰©åˆ†ç´šæ¨£å¼ */
        .drug-tier { padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 6px solid; }
        .tier-1 { background: var(--tier1); border-color: var(--success); }
        .tier-2 { background: var(--tier2); border-color: var(--warning); }
        .tier-label { font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; display: block; }

        /* åœ–è¡¨å®¹å™¨ */
        .chart-container { position: relative; height: 220px; width: 100%; }

        #loading { text-align: center; padding: 100px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div id="loading">ğŸ“Š æ­£åœ¨è®€å– FHIR è‡¨åºŠæ•¸æ“š...</div>

    <div id="content" style="display:none;">
        <header>
            <h1 style="margin:0; font-size: 22px;">ç³–å°¿ç—…è‡¨åºŠæ±ºç­–è¼”åŠ©ç³»çµ± (ADA 2025)</h1>
            <p id="p-info" style="opacity:0.8; margin: 10px 0 0;"></p>
        </header>

        <div class="grid">
            <div class="card">
                <div class="card-title">HbA1c æ­·å²è¶¨å‹¢ (æœ€è¿‘ 5 æ¬¡)</div>
                <div class="chart-container">
                    <canvas id="a1cChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-title">è‡¨åºŠå¿«ç…§</div>
                <p>æœ€æ–° A1C: <strong id="curr-a1c" style="font-size: 24px;">--</strong></p>
                <div id="comp-badges"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ADA 2025 å€‹äººåŒ–ç”¨è—¥å»ºè­°</div>
            <div id="decision-engine">
                </div>
        </div>
        
        <p style="text-align:center; font-size:12px; color:#94a3b8; margin-top:20px;">
            æ­¤ç‚ºæ±ºç­–æ”¯æ´ç³»çµ±ï¼Œæœ€çµ‚è™•æ–¹è«‹ä»¥é†«å¸«è‡¨åºŠåˆ¤æ–·ç‚ºä¸»ã€‚
        </p>
    </div>
</div>

<script>
    let a1cChart = null;

    FHIR.oauth2.ready().then(client => {
        // æŠ“å–ç—…æ‚£ã€æ­·å² A1C (æœ€å¤š5æ¬¡)ã€è¨ºæ–·
        const qPatient = client.patient.read();
        const qA1c = client.request(`Observation?patient=${client.patient.id}&code=4548-4&_sort=-date&_count=5`);
        const qCond = client.request(`Condition?patient=${client.patient.id}`);

        Promise.all([qPatient, qA1c, qCond]).then(([patient, a1cBundle, condBundle]) => {
            document.getElementById("loading").style.display = "none";
            document.getElementById("content").style.display = "block";

            // 1. åŸºæœ¬è³‡è¨Š
            const name = patient.name ? patient.name[0].text : "æœªçŸ¥";
            document.getElementById("p-info").innerText = `ç—…æ‚£å§“åï¼š${name} | æ€§åˆ¥ï¼š${patient.gender} | IDï¼š${patient.id}`;

            // 2. è™•ç†åœ–è¡¨æ•¸æ“š
            let a1cDates = [];
            let a1cValues = [];
            if (a1cBundle.entry) {
                // åè½‰æ•¸çµ„è®“æ—¥æœŸå¾èˆŠåˆ°æ–°
                const entries = [...a1cBundle.entry].reverse();
                entries.forEach(e => {
                    a1cDates.push(new Date(e.resource.effectiveDateTime).toLocaleDateString());
                    a1cValues.push(e.resource.valueQuantity.value);
                });
            }

            // æ›´æ–°å³å´å¤§å­—é«”
            const latestA1c = a1cValues[a1cValues.length - 1] || 0;
            document.getElementById("curr-a1c").innerText = latestA1c + "%";
            if (latestA1c > 7) document.getElementById("curr-a1c").style.color = "var(--danger)";

            // 3. ç¹ªè£½åœ–è¡¨
            const ctx = document.getElementById('a1cChart').getContext('2d');
            a1cChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: a1cDates,
                    datasets: [{
                        label: 'HbA1c (%)',
                        data: a1cValues,
                        borderColor: '#0061f2',
                        backgroundColor: 'rgba(0, 97, 242, 0.